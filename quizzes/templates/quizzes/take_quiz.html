{% extends "base.html" %}
{% block title %}{{ quiz.title }}{% endblock %}

{% block content %}
<h1 style="margin-bottom: 12px;">{{ quiz.title }}</h1>

{% if remaining_seconds != None %}
  <div class="msg" id="timerBox" style="font-size: 14px; font-weight: 700;">
    ‚è±Ô∏è Time left: <span id="timerText"></span>
  </div>
{% endif %}

<!-- ‚úÖ Overlay shown if teacher stops quiz -->
<div id="quizStoppedOverlay" class="quiz-stopped-overlay" style="display:none;">
  <div class="quiz-stopped-card">
    <h2 style="margin:0 0 8px;">Quiz Closed</h2>
    <p style="margin:0 0 14px; opacity:.85;">
      The teacher stopped this quiz. You can't continue.
    </p>
    <a class="btn primary" href="{% url 'home' %}" style="display: inline-block; width: auto;">Back Home</a>
  </div>
</div>

{% if quiz.quiz_type == 'file_upload' %}
  <!-- FILE UPLOAD QUIZ -->
  <form id="quizForm" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    
    <div class="card">
      <div class="upload-instructions">
        <p style="font-size: 16px; font-weight: 600; margin: 0 0 12px;">üìÑ Upload Your Submission</p>
        <p style="color: var(--muted); margin: 0 0 16px;">
          Upload your answer as a PDF or image file (JPG, PNG). Maximum file size: 10MB.
        </p>
      </div>
      
      <div class="upload-area" id="uploadArea">
        <input type="file" name="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png" required style="display: none;">
        <div class="upload-content" onclick="document.getElementById('fileInput').click()">
          <div class="upload-icon">üìÅ</div>
          <p class="upload-text">Click to select file or drag & drop</p>
          <p class="upload-hint">PDF, JPG, PNG (Max 10MB)</p>
        </div>
        <div class="file-preview" id="filePreview" style="display: none;">
          <span class="file-name" id="fileName"></span>
          <button type="button" class="remove-file" onclick="removeFile()">‚úï</button>
        </div>
      </div>
    </div>
    
    <button id="submitBtn" class="btn primary" type="submit" style="width: 100%; padding: 14px; font-size: 16px; margin-top: 20px;">Submit File</button>
  </form>

{% elif quiz.quiz_type == 'true_false' %}
  <!-- TRUE/FALSE QUIZ -->
  <form id="quizForm" method="post">
    {% csrf_token %}

    {% for q in questions %}
      <div class="card" style="margin-bottom: 14px;">
        <p style="margin: 0 0 12px 0; font-weight: 700; font-size: 15px;"><b>Q{{ forloop.counter }}.</b> {{ q.text }}</p>

        {% if q.image %}
          <img src="{{ q.image.url }}" style="max-width: 100%; border-radius: 10px; margin: 10px 0;">
        {% endif %}

        <div class="tf-answer-options">
          <label class="tf-answer-option">
            <input type="radio" name="question_{{ q.id }}" value="1" required>
            <span class="tf-answer true">‚úì True</span>
          </label>
          <label class="tf-answer-option">
            <input type="radio" name="question_{{ q.id }}" value="2">
            <span class="tf-answer false">‚úó False</span>
          </label>
        </div>
      </div>
    {% empty %}
      <div class="card">
        <p style="color: var(--muted);">No questions have been added to this quiz yet.</p>
      </div>
    {% endfor %}

    {% if questions %}
      <button id="submitBtn" class="btn primary" type="submit" style="width: 100%; padding: 14px; font-size: 16px; margin-top: 20px;">Submit Quiz</button>
    {% endif %}
  </form>

{% else %}
  <!-- MULTIPLE CHOICE QUIZ (default) -->
  <form id="quizForm" method="post">
    {% csrf_token %}

    {% for q in questions %}
      <div class="card" style="margin-bottom: 14px;">
        <p style="margin: 0 0 12px 0; font-weight: 700; font-size: 15px;"><b>Q{{ forloop.counter }}.</b> {{ q.text }}</p>

        {% if q.image %}
          <img src="{{ q.image.url }}" style="max-width: 100%; border-radius: 10px; margin: 10px 0;">
        {% endif %}

        <div style="margin-top: 12px;">
          <label style="display: block; padding: 8px 0; margin: 0; cursor: pointer;">
            <input type="radio" name="question_{{ q.id }}" value="1" style="margin-right: 8px; cursor: pointer;" required> 
            <span>{{ q.option1 }}</span>
          </label>
          <label style="display: block; padding: 8px 0; margin: 0; cursor: pointer;">
            <input type="radio" name="question_{{ q.id }}" value="2" style="margin-right: 8px; cursor: pointer;"> 
            <span>{{ q.option2 }}</span>
          </label>
          <label style="display: block; padding: 8px 0; margin: 0; cursor: pointer;">
            <input type="radio" name="question_{{ q.id }}" value="3" style="margin-right: 8px; cursor: pointer;"> 
            <span>{{ q.option3 }}</span>
          </label>
          <label style="display: block; padding: 8px 0; margin: 0; cursor: pointer;">
            <input type="radio" name="question_{{ q.id }}" value="4" style="margin-right: 8px; cursor: pointer;"> 
            <span>{{ q.option4 }}</span>
          </label>
        </div>
      </div>
    {% empty %}
      <div class="card">
        <p style="color: var(--muted);">No questions have been added to this quiz yet.</p>
      </div>
    {% endfor %}

    {% if questions %}
      <button id="submitBtn" class="btn primary" type="submit" style="width: 100%; padding: 14px; font-size: 16px; margin-top: 20px;">Submit Quiz</button>
    {% endif %}
  </form>
{% endif %}

<style>
  /* Professional overlay */
  .quiz-stopped-overlay{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.72);
    z-index: 99999;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 18px;
  }
  .quiz-stopped-card{
    width: min(520px, 92vw);
    border-radius: 18px;
    padding: 18px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(17,24,39,.92);
    box-shadow: 0 18px 55px rgba(0,0,0,.50);
  }
  
  /* True/False answer styles */
  .tf-answer-options {
    display: flex;
    gap: 12px;
    margin-top: 12px;
  }
  
  .tf-answer-option {
    flex: 1;
    cursor: pointer;
  }
  
  .tf-answer-option input {
    display: none;
  }
  
  .tf-answer {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 14px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 15px;
    border: 2px solid var(--border);
    transition: all 0.2s ease;
  }
  
  .tf-answer.true {
    background: rgba(16, 185, 129, 0.05);
  }
  
  .tf-answer.false {
    background: rgba(239, 68, 68, 0.05);
  }
  
  .tf-answer-option input:checked + .tf-answer.true {
    background: rgba(16, 185, 129, 0.2);
    border-color: #10b981;
    color: #10b981;
  }
  
  .tf-answer-option input:checked + .tf-answer.false {
    background: rgba(239, 68, 68, 0.2);
    border-color: #ef4444;
    color: #ef4444;
  }
  
  /* File upload styles */
  .upload-area {
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    transition: all 0.2s ease;
    background: rgba(255, 255, 255, 0.02);
  }
  
  .upload-area.dragover {
    border-color: var(--accent);
    background: rgba(37, 99, 235, 0.05);
  }
  
  .upload-content {
    cursor: pointer;
  }
  
  .upload-icon {
    font-size: 48px;
    margin-bottom: 12px;
  }
  
  .upload-text {
    font-weight: 600;
    margin: 0 0 6px;
  }
  
  .upload-hint {
    color: var(--muted);
    font-size: 13px;
    margin: 0;
  }
  
  .file-preview {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 12px;
    background: rgba(37, 99, 235, 0.1);
    border-radius: 8px;
  }
  
  .file-name {
    font-weight: 500;
    color: var(--accent);
  }
  
  .remove-file {
    background: rgba(239, 68, 68, 0.2);
    border: none;
    color: #ef4444;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 12px;
  }
</style>

<script>
(function(){
  const formEl = document.getElementById("quizForm");
  const submitBtn = document.getElementById("submitBtn");
  const overlay = document.getElementById("quizStoppedOverlay");

  // ‚úÖ Quiz status endpoint
  const statusUrl = "{% url 'quiz_status' quiz.code %}";

  // ‚úÖ track if quiz is stopped
  let stopped = false;

  function lockUI(){
    if (stopped) return;
    stopped = true;

    // Disable all inputs and submit
    document.querySelectorAll("#quizForm input, #quizForm button, #quizForm select, #quizForm textarea")
      .forEach(el => el.disabled = true);

    overlay.style.display = "flex";
  }

  async function checkStatus(){
    try{
      const res = await fetch(statusUrl, { cache: "no-store" });
      const data = await res.json();
      if (!data.active){
        lockUI();
      }
    }catch(e){
      // ignore temporary network errors
    }
  }

  // check immediately + every 2 seconds
  checkStatus();
  setInterval(checkStatus, 1000);

  // -----------------------------
  // ‚úÖ File upload handling
  // -----------------------------
  const fileInput = document.getElementById('fileInput');
  const uploadArea = document.getElementById('uploadArea');
  const uploadContent = uploadArea ? uploadArea.querySelector('.upload-content') : null;
  const filePreview = document.getElementById('filePreview');
  const fileName = document.getElementById('fileName');
  
  if (fileInput && uploadArea) {
    fileInput.addEventListener('change', function() {
      if (this.files.length > 0) {
        showFilePreview(this.files[0]);
      }
    });
    
    uploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
      if (e.dataTransfer.files.length > 0) {
        fileInput.files = e.dataTransfer.files;
        showFilePreview(e.dataTransfer.files[0]);
      }
    });
  }
  
  window.showFilePreview = function(file) {
    if (uploadContent) uploadContent.style.display = 'none';
    if (filePreview) filePreview.style.display = 'flex';
    if (fileName) fileName.textContent = file.name;
  };
  
  window.removeFile = function() {
    if (fileInput) fileInput.value = '';
    if (uploadContent) uploadContent.style.display = 'block';
    if (filePreview) filePreview.style.display = 'none';
  };

  // -----------------------------
  // ‚úÖ Timer logic
  // -----------------------------
  {% if remaining_seconds != None %}
    const timerEl = document.getElementById("timerText");
    let remaining = Number("{{ remaining_seconds }}");

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(";").shift();
      return null;
    }

    function ensureCsrfInput() {
      if (!formEl.querySelector('input[name="csrfmiddlewaretoken"]')) {
        const csrf = getCookie("csrftoken");
        if (csrf) {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = "csrfmiddlewaretoken";
          input.value = csrf;
          formEl.prepend(input);
        }
      }
    }

    function fmt(sec){
      const m = Math.floor(sec/60);
      const s = sec % 60;
      return `${m}:${String(s).padStart(2,"0")}`;
    }

    function tick(){
      // if teacher stopped quiz, don't auto-submit
      if (stopped) return;

      timerEl.textContent = fmt(remaining);

      if (remaining <= 0) {
        ensureCsrfInput();
        formEl.submit();
        return;
      }

      remaining--;
      setTimeout(tick, 1000);
    }

    tick();
  {% endif %}
})();
</script>

{% endblock %}
