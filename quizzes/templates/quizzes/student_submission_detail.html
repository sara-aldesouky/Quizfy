{% extends "base.html" %}
{% load quiz_extras %}

{% block title %}Submission Details{% endblock %}

{% block content %}
<div class="submission-header">
  <a href="{% url 'student_dashboard' %}" class="back-link">‚Üê Back to Dashboard</a>
  <h1>Submission Details</h1>
</div>

<!-- Quiz Info Card -->
<div class="quiz-info-card">
  <div class="quiz-main-info">
    <h2>{{ quiz.title }}</h2>
    <span class="quiz-code">{{ quiz.code }}</span>
  </div>
  <div class="submission-stats">
    <div class="stat-item">
      <div class="stat-value {% if submission.total > 0 %}{% if submission.score == submission.total %}perfect{% elif submission.score >= submission.total|divisibleby:2 %}good{% endif %}{% endif %}">
        {{ submission.score }}/{{ submission.total }}
      </div>
      <div class="stat-label">Score</div>
    </div>
    <div class="stat-divider"></div>
    <div class="stat-item">
      <div class="stat-value">{{ submission.submitted_at|date:"M d" }}</div>
      <div class="stat-label">{{ submission.submitted_at|date:"H:i" }}</div>
    </div>
  </div>
</div>

<!-- File Submissions Section (for file upload quizzes) -->
{% if file_submissions %}
  <div class="section-header">
    <h3>üìÑ Your Uploaded Files</h3>
  </div>
  
  {% for fs in file_submissions %}
    <div class="file-card {% if fs.grade %}graded{% endif %}">
      {% if fs.question %}
        <div class="file-question">
          <span class="question-label">Question:</span> {{ fs.question.text }}
        </div>
      {% endif %}
      
      <div class="file-row">
        <div class="your-file">
          <div class="file-label">üìé Your Submission</div>
          <div class="file-item">
            <span class="file-icon">üìÑ</span>
            <span class="file-name">{{ fs.file_name }}</span>
            <button type="button" class="btn secondary small" onclick="openFilePreview('{{ fs.file.url }}', '{{ fs.file_name }}')">üëÅÔ∏è View</button>
          </div>
          <div class="file-date">Uploaded {{ fs.uploaded_at|date:"M d, Y H:i" }}</div>
        </div>
        
        {% if fs.teacher_file %}
          <div class="teacher-file">
            <div class="file-label">üìù Teacher's Feedback File</div>
            <div class="file-item corrected">
              <span class="file-icon">‚úÖ</span>
              <span class="file-name">{{ fs.teacher_file_name }}</span>
              <button type="button" class="btn primary small" onclick="openFilePreview('{{ fs.teacher_file.url }}', '{{ fs.teacher_file_name }}')">üëÅÔ∏è View Corrected</button>
            </div>
          </div>
        {% endif %}
      </div>
      
      {% if fs.grade or fs.teacher_comment %}
        <div class="grading-feedback">
          {% if fs.grade %}
            <div class="grade-display">
              <span class="grade-label">Grade:</span>
              <span class="grade-value">{{ fs.grade }}</span>
            </div>
          {% endif %}
          
          {% if fs.teacher_comment %}
            <div class="teacher-comment">
              <div class="comment-header">
                <span class="comment-icon">üí¨</span>
                <span class="comment-title">Teacher's Feedback</span>
              </div>
              <div class="comment-text">{{ fs.teacher_comment }}</div>
            </div>
          {% endif %}
          
          {% if fs.graded_at %}
            <div class="graded-time">Graded on {{ fs.graded_at|date:"M d, Y" }} at {{ fs.graded_at|date:"H:i" }}</div>
          {% endif %}
        </div>
      {% elif quiz.quiz_type == 'file_upload' or fs.question.question_type == 'file_upload' %}
        <div class="pending-grade">
          <span class="pending-icon">‚è≥</span>
          <span>Awaiting teacher review</span>
        </div>
      {% endif %}
    </div>
  {% endfor %}
{% endif %}

<!-- Question Answers Section -->
{% if answers %}
  <div class="section-header">
    <h3>üìù Question Review</h3>
  </div>

  <div class="answers-list">
    {% for a in answers %}
      <div class="answer-card {% if a.question.question_type == 'file_upload' %}file-type{% elif a.is_correct %}correct{% else %}incorrect{% endif %}">
        <div class="answer-header">
          <span class="q-number">Q{{ forloop.counter }}</span>
          {% if a.question.question_type == 'file_upload' %}
            <span class="type-badge file">üìÑ File Upload</span>
          {% elif a.question.question_type == 'true_false' %}
            <span class="type-badge tf">T/F</span>
          {% else %}
            <span class="type-badge mc">MC</span>
          {% endif %}
          {% if a.question.question_type != 'file_upload' %}
            {% if a.is_correct %}
              <span class="result correct">‚úì Correct</span>
            {% else %}
              <span class="result incorrect">‚úó Wrong</span>
            {% endif %}
          {% endif %}
        </div>
        
        <div class="question-text">{{ a.question.text }}</div>

        {% if a.question.image %}
          <img src="{{ a.question.image.url }}" class="question-image" alt="Question image">
        {% endif %}

        {% if a.question.question_type != 'file_upload' %}
          <div class="answer-comparison">
            <div class="answer-box your-answer">
              <div class="answer-label">Your Answer</div>
              <div class="answer-value">
                {% if a.question.question_type == 'true_false' %}
                  {% if a.selected == 1 %}‚úì True{% elif a.selected == 2 %}‚úó False{% else %}‚Äî{% endif %}
                {% else %}
                  {% if a.selected %}
                    {{ a.question|option_text:a.selected }}
                  {% else %}
                    (no answer)
                  {% endif %}
                {% endif %}
              </div>
            </div>
            <div class="answer-box correct-answer">
              <div class="answer-label">Correct Answer</div>
              <div class="answer-value">
                {% if a.question.question_type == 'true_false' %}
                  {% if a.question.correct_option == 1 %}‚úì True{% else %}‚úó False{% endif %}
                {% else %}
                  {{ a.question|option_text:a.question.correct_option }}
                {% endif %}
              </div>
            </div>
          </div>
        {% else %}
          <!-- File upload question - handled in file_submissions loop -->
          <div class="file-upload-note">
            <span>üìé See file submission above</span>
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
{% endif %}

<style>
.submission-header {
  margin-bottom: 24px;
}

.back-link {
  display: inline-block;
  color: var(--muted);
  text-decoration: none;
  font-size: 14px;
  margin-bottom: 8px;
  transition: color 0.2s;
}

.back-link:hover {
  color: var(--accent);
}

.submission-header h1 {
  margin: 0;
}

/* Quiz Info Card */
.quiz-info-card {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(135deg, rgba(37, 99, 235, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px 24px;
  margin-bottom: 28px;
}

.quiz-main-info h2 {
  margin: 0 0 6px 0;
  font-size: 1.25rem;
}

.quiz-code {
  display: inline-block;
  background: rgba(255, 255, 255, 0.1);
  padding: 4px 12px;
  border-radius: 6px;
  font-size: 13px;
  font-family: monospace;
}

.submission-stats {
  display: flex;
  align-items: center;
  gap: 20px;
}

.stat-item {
  text-align: center;
}

.stat-value {
  font-size: 1.5rem;
  font-weight: 700;
}

.stat-value.perfect {
  color: #10b981;
}

.stat-value.good {
  color: #3b82f6;
}

.stat-label {
  font-size: 12px;
  color: var(--muted);
  margin-top: 2px;
}

.stat-divider {
  width: 1px;
  height: 40px;
  background: var(--border);
}

/* Section Headers */
.section-header {
  margin: 28px 0 16px;
}

.section-header h3 {
  margin: 0;
  font-size: 1.1rem;
}

/* File Cards */
.file-card {
  background: var(--card0);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 20px;
  margin-bottom: 16px;
}

.file-card.graded {
  border-left: 4px solid #10b981;
}

.file-question {
  font-size: 14px;
  margin-bottom: 14px;
  padding-bottom: 14px;
  border-bottom: 1px solid var(--border);
}

.question-label {
  color: var(--muted);
}

.file-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.file-label {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 10px;
  color: var(--muted);
}

.file-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 14px;
  background: rgba(255, 255, 255, 0.03);
  border-radius: 10px;
}

.file-item.corrected {
  background: rgba(16, 185, 129, 0.1);
}

.file-icon {
  font-size: 20px;
}

.file-name {
  flex: 1;
  font-weight: 500;
  word-break: break-word;
}

.file-date {
  font-size: 12px;
  color: var(--muted);
  margin-top: 8px;
}

/* Grading Feedback */
.grading-feedback {
  margin-top: 18px;
  padding-top: 18px;
  border-top: 1px solid var(--border);
}

.grade-display {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 8px 16px;
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(59, 130, 246, 0.2));
  border-radius: 10px;
  margin-bottom: 14px;
}

.grade-label {
  font-size: 13px;
  color: var(--muted);
}

.grade-value {
  font-size: 1.25rem;
  font-weight: 700;
  color: #10b981;
}

.teacher-comment {
  background: rgba(255, 255, 255, 0.03);
  border-radius: 12px;
  padding: 16px;
  margin-top: 14px;
}

.comment-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
}

.comment-icon {
  font-size: 18px;
}

.comment-title {
  font-weight: 600;
  font-size: 14px;
}

.comment-text {
  font-size: 14px;
  line-height: 1.6;
  color: var(--text);
  white-space: pre-wrap;
}

.graded-time {
  font-size: 12px;
  color: var(--muted);
  margin-top: 14px;
}

.pending-grade {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 16px;
  padding: 12px 16px;
  background: rgba(245, 158, 11, 0.1);
  border-radius: 10px;
  color: #fbbf24;
  font-size: 14px;
}

.pending-icon {
  font-size: 18px;
}

/* Answer Cards */
.answers-list {
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.answer-card {
  background: var(--card0);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 18px;
}

.answer-card.correct {
  border-left: 4px solid #10b981;
}

.answer-card.incorrect {
  border-left: 4px solid #ef4444;
}

.answer-card.file-type {
  border-left: 4px solid #3b82f6;
}

.answer-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
}

.q-number {
  font-weight: 700;
  font-size: 14px;
  color: var(--muted);
}

.type-badge {
  padding: 3px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
}

.type-badge.mc {
  background: rgba(59, 130, 246, 0.15);
  color: #60a5fa;
}

.type-badge.tf {
  background: rgba(16, 185, 129, 0.15);
  color: #34d399;
}

.type-badge.file {
  background: rgba(245, 158, 11, 0.15);
  color: #fbbf24;
}

.result {
  margin-left: auto;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}

.result.correct {
  background: rgba(16, 185, 129, 0.15);
  color: #10b981;
}

.result.incorrect {
  background: rgba(239, 68, 68, 0.15);
  color: #ef4444;
}

.question-text {
  font-size: 15px;
  line-height: 1.5;
  margin-bottom: 14px;
}

.question-image {
  max-width: 100%;
  border-radius: 10px;
  margin-bottom: 14px;
}

.answer-comparison {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.answer-box {
  padding: 14px;
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.03);
}

.answer-label {
  font-size: 12px;
  color: var(--muted);
  margin-bottom: 6px;
}

.answer-value {
  font-weight: 600;
  font-size: 14px;
}

.file-upload-note {
  padding: 12px;
  background: rgba(59, 130, 246, 0.1);
  border-radius: 8px;
  font-size: 13px;
  color: var(--muted);
}

.btn.small {
  padding: 6px 12px;
  font-size: 12px;
}

/* Responsive */
@media (max-width: 768px) {
  .quiz-info-card {
    flex-direction: column;
    text-align: center;
    gap: 16px;
  }
  
  .file-row {
    grid-template-columns: 1fr;
  }
  
  .answer-comparison {
    grid-template-columns: 1fr;
  }
}
</style>

<!-- File Preview Modal -->
<div id="filePreviewModal" class="preview-modal" style="display: none;">
  <div class="preview-modal-content">
    <div class="preview-header">
      <h3 id="previewFileName">File Preview</h3>
      <div class="preview-actions">
        <a id="previewDownload" href="#" download class="btn secondary small">üì• Download</a>
        <a id="previewOpenNew" href="#" target="_blank" class="btn secondary small">üîó Open in New Tab</a>
        <button type="button" onclick="closeFilePreview()" class="btn danger small">‚úï Close</button>
      </div>
    </div>
    <div class="preview-body">
      <iframe id="previewFrame" src="" style="width: 100%; height: 100%; border: none;"></iframe>
      <div id="previewImage" style="display: none; text-align: center; padding: 20px; overflow: auto;">
        <img id="previewImg" src="" style="max-width: 100%; max-height: 80vh; border-radius: 8px;">
      </div>
    </div>
  </div>
</div>

<style>
/* Preview Modal Styles */
.preview-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.preview-modal-content {
  background: var(--card0);
  border-radius: 16px;
  width: 95%;
  max-width: 1200px;
  height: 90vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.preview-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  background: var(--card1);
}

.preview-header h3 {
  margin: 0;
  font-size: 1rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 50%;
}

.preview-actions {
  display: flex;
  gap: 8px;
}

.preview-body {
  flex: 1;
  overflow: hidden;
  background: #1a1a1a;
}

@media (max-width: 768px) {
  .preview-modal-content {
    width: 100%;
    height: 100vh;
    border-radius: 0;
  }
  
  .preview-header {
    flex-direction: column;
    gap: 12px;
    align-items: flex-start;
  }
  
  .preview-header h3 {
    max-width: 100%;
  }
  
  .preview-actions {
    width: 100%;
    flex-wrap: wrap;
  }
}
</style>

<script>
function openFilePreview(url, filename) {
  const modal = document.getElementById('filePreviewModal');
  const frame = document.getElementById('previewFrame');
  const imageContainer = document.getElementById('previewImage');
  const img = document.getElementById('previewImg');
  const filenameEl = document.getElementById('previewFileName');
  const downloadLink = document.getElementById('previewDownload');
  const openNewLink = document.getElementById('previewOpenNew');
  
  filenameEl.textContent = filename;
  downloadLink.href = url;
  openNewLink.href = url;
  
  const ext = filename.split('.').pop().toLowerCase();
  
  if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
    // Show image preview
    frame.style.display = 'none';
    imageContainer.style.display = 'block';
    img.src = url;
  } else {
    // Show PDF/other in iframe
    frame.style.display = 'block';
    imageContainer.style.display = 'none';
    frame.src = url;
  }
  
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeFilePreview() {
  const modal = document.getElementById('filePreviewModal');
  const frame = document.getElementById('previewFrame');
  
  modal.style.display = 'none';
  frame.src = '';
  document.body.style.overflow = '';
}

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeFilePreview();
  }
});

// Close modal when clicking outside content
document.getElementById('filePreviewModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeFilePreview();
  }
});
</script>
{% endblock %}
